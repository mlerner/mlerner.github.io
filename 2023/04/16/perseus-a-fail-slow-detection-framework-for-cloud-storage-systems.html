<!DOCTYPE html>
<html>
  <head>
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-LKBDWTJ60B"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-LKBDWTJ60B");
    </script>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Perseus: A Fail-Slow Detection Framework for Cloud Storage Systems</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />

    <meta http-equiv="pragma" content="no-cache" />
    <meta name="robots" content="all" />
    <meta name="MSSmartTagsPreventParsing" content="true" />
    <meta http-equiv="imagetoolbar" content="false" />

    <link href="/css/tufte.css" rel="stylesheet" />
    <link
      rel="alternate"
      type="application/atom+xml"
      title="Atom Feed for www.micahlerner.com"
      href="/atom.xml"
    />
    <link
      rel="alternate"
      type="application/atom+xml"
      title="RSS Feed for www.micahlerner.com"
      href="/feed.xml"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/assets/images/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/assets/images/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/assets/images/favicon-16x16.png"
    />
    <link rel="manifest" href="/assets/imagessite.webmanifest" />
  </head>

  <body>
    <article>
  <section>
    <header>
      <a href="/">
        <h3>micahlerner.com</h3>
      </a>
    </header>
  </section>
  <h1>Perseus: A Fail-Slow Detection Framework for Cloud Storage Systems</h1>
  
  <h4>Published April 16, 2023</h4>
  <h5>
    Found something wrong?
    <a
      href="https://github.com/mlerner/mlerner.github.io/edit/master/_posts/2023-04-16-perseus-a-fail-slow-detection-framework-for-cloud-storage-systems.md"
      >Submit a pull request!</a
    >
  </h5>
  <section id="post-content">
       <p class='discussion'>Discussion on <a href='https://news.ycombinator.com/item?id=35765100'> Hacker News</a></p>  
    <p>
      <em>
        The Perseus paper won a best paper award at FAST (File and Storage Technologies) and is one in a series I will be writing about from that conference. These paper reviews can <a href="https://newsletter.micahlerner.com/">be delivered weekly to your inbox</a>, or you can subscribe to the <a href="https://www.micahlerner.com/feed.xml">Atom feed</a>. As always, feel free to reach out on <a href="https://twitter.com/micahlerner">Twitter</a> with feedback or suggestions!

        
      </em>
    </p>

     <p><a href="https://www.usenix.org/conference/fast23/presentation/lu">Perseus: A Fail-Slow Detection Framework for Cloud Storage Systems</a></p>

<h2 id="what-is-the-research">What is the research?</h2>

<p>This paper describes a system for detecting <em>fail-slow</em> instances in Alibaba storage clusters - <em>fail-slow</em><label for="fs" class="margin-toggle sidenote-number"></label><input type="checkbox" id="fs" class="margin-toggle" /><span class="sidenote"> <em>Fail-slow</em> is documented by previous research, including <a href="https://www.usenix.org/system/files/conference/fast18/fast18-gunawi.pdf">Fail-Slow at Scale: Evidence of Hardware Performance Faults in Large Production Systems</a> (which has a great paper review from Adrian Colyer’s blog <a href="https://blog.acolyer.org/2018/02/26/fail-slow-at-scale-evidence-of-hardware-performance-faults-in-large-production-systems/">here</a>). </span> is failure mode in which hardware fails non-obviously, potentially by consistently degrading performance over time. While hardware deployed in data centers at scale fails for a variety of reasons (including environmental conditions, and hardware defects), automated detection normally finds these problems, allowing quick remediation by oncall engineers at the datacenter. Unfortunately, not all hardware misbehavior follows this path, as noted by previous research into <em>fail-slow</em>.</p>

<p>The Perseus paper focuses specifically on detecting <em>fail-slow</em> in storage devices, although the category of problem impacts a wide variety of hardware. If left unresolved, <em>fail-slow</em> instances can dramatically impact performance and tail latency<label for="tail" class="margin-toggle sidenote-number"></label><input type="checkbox" id="tail" class="margin-toggle" /><span class="sidenote">See the <a href="https://dl.acm.org/doi/10.1145/2408776.2408794">The Tail at Scale</a>, and the associated paper review from <a href="https://blog.acolyer.org/2015/01/15/the-tail-at-scale/">The Morning Paper</a>. </span>. For example, if a drive fails, database writes reaching that drive may automatically fail or take a significant period of time to complete. The degradation can be particularly acute for distributed systems requiring multiple acknowledgements of a write before returning success to a client<label for="cassandrda" class="margin-toggle sidenote-number"></label><input type="checkbox" id="cassandrda" class="margin-toggle" /><span class="sidenote">For example, Cassandra accomplishes this using different <a href="https://javadoc.io/static/org.apache.cassandra/cassandra-thrift/1.2.14/org/apache/cassandra/thrift/ConsistencyLevel.html">consistency levels</a>. </span>. Continuing speedups of hardware further exacerbates the problem<label for="ms" class="margin-toggle sidenote-number"></label><input type="checkbox" id="ms" class="margin-toggle" /><span class="sidenote">See <a href="https://www.barroso.org/publications/AttackoftheKillerMicroseconds.pdf">Attack of the Killer Microseconds</a>. </span>.</p>

<figure><img class="maincolumn-img" src="/assets/perseus/figure2.png" /><figcaption class="maincolumn-figure"></figcaption></figure>

<p>The <em>fail-slow</em> phenomenon is difficult to detect for a variety of reasons. Typical SLO-based approaches monitoring a fixed performance threshold are insufficiently sensitive - varying load can cause periodic performance regressions, even if a drive is healthy<label for="slo" class="margin-toggle sidenote-number"></label><input type="checkbox" id="slo" class="margin-toggle" /><span class="sidenote">SLOs are described in more detail in the <a href="https://sre.google/sre-book/service-level-objectives/">SRE book</a>. </span>. Othere orevious work<label for="iaso" class="margin-toggle sidenote-number"></label><input type="checkbox" id="iaso" class="margin-toggle" /><span class="sidenote">The <a href="https://www.usenix.org/conference/atc19/presentation/panda">IASO model</a> is one example - it relies on timeouts recorded by systems like Cassandra to identify problematic machines. </span> to identify <em>fail-slow</em> cases relies on deep integration with an application, which isn’t possible for cloud providers (who oftentimes have limited visibility into user workloads). The Perseus paper is novel in several respects, including not relying on deep knowledge of the workloads it is monitoring for detection.</p>

<h2 id="what-are-the-papers-contributions">What are the paper’s contributions?</h2>

<p>The paper makes four main contributions:</p>

<ul>
  <li>A framework for detecting instances of fail-slow at scale, including takeaways about what did not work.</li>
  <li>The design and implementation of Perseus, a system for detecting fail-slow instances in storage clusters.</li>
  <li>An evaluation of the technique against a ground truth dataset from Alibaba.</li>
  <li>Root-cause analysis of detected failures.</li>
</ul>

<h2 id="how-does-the-system-work">How does the system work?</h2>

<p>In instrumenting their approach, the authors set out with several main design goals:</p>

<ul>
  <li><em>Non-intrusive</em>: Alibaba runs cloud workloads, and doesn’t necessarily need (or want) to rely on deeper integration with customer applications.</li>
  <li><em>Fine-grained</em>: failures identified by the system should be specific about what hardware is failing and why.</li>
  <li><em>Accurate</em>: the system should correctly identify failures, limiting wasted time by oncall engineers.</li>
  <li><em>General</em>: the solution should be able to identify problems across different types of hardware within the same category (for example both SSDs and HDDs).</li>
</ul>

<p>The team built up a dataset of drive performance using daemons deployed in the Alibaba cloud, recording time series of average latency, average throughput keyed by machine and drive (as a machine can have many drives).</p>

<figure><img class="maincolumn-img" src="/assets/perseus/table2.png" /><figcaption class="maincolumn-figure"></figcaption></figure>

<h3 id="initial-attempts">Initial Attempts</h3>

<p>With these goals in mind, the authors evaluated three different techniques for detecting fail-slow instances: <em>threshold filtering</em>, <em>peer evaluation</em>, and an approach based on previous research named IASO<label for="iaso" class="margin-toggle sidenote-number"></label><input type="checkbox" id="iaso" class="margin-toggle" /><span class="sidenote"><a href="https://www.usenix.org/conference/atc19/presentation/panda">IASO: A Fail-Slow Detection and Mitigation Framework for Distributed Storage Services</a> was previously published at Usenix ATC 2019. </span>. Each of these techniques had their shortcomings with respect to the design goals.</p>

<p><em>Threshold filtering</em> relied on identifying problematic drives by recording whether write latency increased over a fixed threshold. This approach didn’t work because disk latency would spike periodically when under heavy load, with little correlation to drive failure.</p>

<figure><img class="maincolumn-img" src="/assets/perseus/figure3.png" /><figcaption class="maincolumn-figure"></figcaption></figure>

<p><em>Peer evaluation</em> compared the performance of drives on the same machine against one another - theoretically drives attached to the same machine should receive somewhat similar workloads if used by the same customer, so repeated deviations of a drive’s performance from its neighbors would flag the drive for further inspection. The main downside to this approach was a reliance on fine-tuning for proper detection - the duration and frequency of deviations differed by clusters and workloads, requiring significant engineering work for accurate detection of fail slow events.</p>

<figure><img class="maincolumn-img" src="/assets/perseus/figure4.png" /><figcaption class="maincolumn-figure"></figcaption></figure>

<p>The last attempted approach described by the authors was one based on previous research from <a href="https://www.usenix.org/system/files/atc19-panda_0.pdf">IASO: A Fail-Slow Detection and Mitigation Framework for Distributed Storage Services</a>. This <em>IASO-based model</em> relies on timeouts - for example, counting the number of timeouts Cassandra has to a specific node, then using this as a proxy for a problematic set of devices. The IASO based approach was not suitable for a number of reasons, including that it targets nodes (rather than specific devices), and relies on knowledge of the workload (which isn’t true of Alibaba’s cloud). The authors still attempted to adapt it to their needs by reusing the output of the peer evaluation approach described above<label for="impl" class="margin-toggle sidenote-number"></label><input type="checkbox" id="impl" class="margin-toggle" /><span class="sidenote">The details of this implementation weren’t clear to me from the paper, but I reached out to one of the authors, <a href="https://twitter.com/giorgioercixu">Giorgio Xu</a> for clarification. :) </span>.</p>

<h3 id="perseus">Perseus</h3>

<p>The final approach that the authors implemented was given the code-name <em>Perseus</em>. It relies on analysis of the distribution of latency vs throughput<label for="ltv" class="margin-toggle sidenote-number"></label><input type="checkbox" id="ltv" class="margin-toggle" /><span class="sidenote">The paper also considered the relationship between latency and IOPS (operations per second), but found it didn’t have as strong of a correlation. </span> for a node - using metrics gathered by Alibaba daemons, the authors determined that latency vs throughput could vary within a cluster and within DB nodes (depending on the specific workload). However, within a specific node there was a closer relationship between latency and throughput, allowing analysis of whether the performance of a specific drive attached to a node deviates from its neighbors.</p>

<figure><img class="maincolumn-img" src="/assets/perseus/figure5.png" /><figcaption class="maincolumn-figure"></figcaption></figure>

<p>Using the data on latency vs throughput for a node, Perseus follows a four step process: <em>performing outlier detection on the raw data</em>, <em>building a regression model</em>, <em>identifying fail slow events</em>, and <em>evaluating the risk of any detected events</em>.</p>

<figure><img class="maincolumn-img" src="/assets/perseus/figure7.png" /><figcaption class="maincolumn-figure"></figcaption></figure>

<p>In the first step, Perseus makes use of two algorithms (DBScan and Principal Component Analysis<label for="algos" class="margin-toggle sidenote-number"></label><input type="checkbox" id="algos" class="margin-toggle" /><span class="sidenote">Both are fairly standard algorithms for analyzing complex datasets - see an in-depth explanations of DBScan <a href="https://www.youtube.com/watch?v=RDZUdRSDOok">here</a> and Principal Component Analysis <a href="https://builtin.com/data-science/step-step-explanation-principal-component-analysis">here</a>. </span>) for identifying outlier data points.</p>

<figure><img class="maincolumn-img" src="/assets/perseus/figure8.png" /><figcaption class="maincolumn-figure"></figcaption></figure>

<p>Next, the system excludes outliers and <em>builds a regression model</em>, producing a curve  that fits remaining data points.</p>

<p>Perseus then runs this regression model over the time series for every drive in the node - for every drive, a given throughput should produce a given latency. Then the system measures the difference between the drive’s actual and expected latency for a given throughput using the <em>slowdown ratio</em> (upper bound of expected latency divided by actual drive latency).</p>

<figure><img class="maincolumn-img" src="/assets/perseus/figure9.png" /><figcaption class="maincolumn-figure"></figcaption></figure>

<p>Lastly, the system scans the <em>slowdown ratio</em> timeseries for every drive, finding and categorizing slow down events based on their duration and severity (represented by a drive’s difference from expected performance). Drives with repeated, severe slowdowns are flagged for further investigation by engineers onsite.</p>

<figure><img class="maincolumn-img" src="/assets/perseus/table3.png" /><figcaption class="maincolumn-figure"></figcaption></figure>

<h2 id="how-is-the-research-evaluated">How is the research evaluated?</h2>

<p>To evalute the research, the authors compare the precision, recall, and Matthews Correlation Coefficient (MCC)<label for="mcc" class="margin-toggle sidenote-number"></label><input type="checkbox" id="mcc" class="margin-toggle" /><span class="sidenote">MCC is described in more depth <a href="https://bmcgenomics.biomedcentral.com/articles/10.1186/s12864-019-6413-7">here</a>. </span> of different approaches - “the precision indicates the percentage of drives identified by a method is indeed a fail-slow one. The recall is the percentage of real fail-slow drives identified by a method.” The authors use MCC because, “it evaluates binary classification models more fairly on imbalanced datasets.” Perseus outperforms each of the other approaches on these three metrics.</p>

<figure><img class="maincolumn-img" src="/assets/perseus/table5.png" /><figcaption class="maincolumn-figure"></figcaption></figure>

<p>The paper also evaluates the different components of Perseus’ design. For example, measuring the impact of outlier removal, the combination of Principal Component Analysis with DBScan, and the thresholds used for what is considered as the upper bound of expected latency for a given throughput (a factor in computing the <em>slowdown ratio</em>). The data from the paper supports their decision making.</p>

<figure><img class="maincolumn-img" src="/assets/perseus/table7.png" /><figcaption class="maincolumn-figure"></figcaption></figure>

<p>Lastly, the paper notes the removal of fail-slow drives is signfiicant on tail latency:</p>

<blockquote>
  <p>The most direct benefit of deploying PERSEUS is reducing tail latency. By isolating the fail-slow, node-level 95th, 99th and 99.99th write latencies are reduced by 30.67% (±10.96%), 46.39% (±14.84%), and 48.05% (±15.53%), respectively.</p>
</blockquote>

<h3 id="root-cause-analysis">Root Cause Analysis</h3>

<p>The paper wraps up by diving into several root-causes of fail slow instances in Alibaba production clusters. Software problems caused a majority of the failures.</p>

<p>One example root cause happened because an operating system bug introduced thread contention<label for="tc" class="margin-toggle sidenote-number"></label><input type="checkbox" id="tc" class="margin-toggle" /><span class="sidenote">See <a href="https://stackoverflow.com/questions/1970345/what-is-thread-contention">this post</a> on thread contention for a deeper dive. </span> - each drive received a thread from the operating system to manage IO, but a software bug would cause multiple drives to share the same thread, impacting performance.</p>

<h2 id="conclusion">Conclusion</h2>

<p>An interesting facet of the paper was quantifying the impact to tail latency from few <em>fail-slow</em> events in a single class of hardware (the paper uses a test dataset of 315 instances). I also appreciated the research identifying potential shortcomings of the approach. For example, Perseus makes the assumption that single (or few) drives on a node will fail-slow at the same time. If all drives attached to a machine fail-slow (which is possible), the system would likely not detect the problem.</p>

<p>For cloud providers with limited instrumentation of customer workloads, the approach seems quite promising, especially with a potential expansion to other <em>fail-slow</em> cases like memory and networking. At the same time, growing adoption of commoditized infrastructure<label for="hosted" class="margin-toggle sidenote-number"></label><input type="checkbox" id="hosted" class="margin-toggle" /><span class="sidenote">For example, Cassandra can be hosted by both <a href="https://aws.amazon.com/keyspaces/">AWS</a> and <a href="https://console.cloud.google.com/marketplace/product/datastax-public/datastax-astra-dbaas?project=gmailctl-2nd">GCP</a>, meaning the provider could use a potentially-simpler IASO-based model. </span> might mean that a Perseus-like approach is applied to only low-level infrastructure.</p>


    <footer>
      <form
        action="https://gmail.us20.list-manage.com/subscribe/post?u=d1654f70a6addb0e9ce8afd83&amp;id=bab65ed2b1"
        method="post"
        id="mc-embedded-subscribe-form"
        name="mc-embedded-subscribe-form"
        class="validate"
        target="_blank"
        novalidate
      >
        <div id="mc_embed_signup_scroll">
          <h4>
            Follow me on
            <a href="https://twitter.com/micahlerner">Twitter</a> or subscribe
            below to get future paper reviews. Published weekly.
          </h4>
          <div>
            <input
              type="email"
              value=""
              name="EMAIL"
              class="email"
              id="tlemail"
              placeholder="email address"
              required
            />
            <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
            <div style="position: absolute; left: -5000px" aria-hidden="true">
              <input
                type="text"
                name="b_d1654f70a6addb0e9ce8afd83_bab65ed2b1"
                tabindex="-1"
                value=""
              />
            </div>
            <input
              type="submit"
              value="Subscribe"
              name="subscribe"
              id="mc-embedded-subscribe"
              class="button"
            />
          </div>
        </div>
      </form>
    </footer>
  </section>
  <section>
    Found something wrong?
    <a
      href="https://github.com/mlerner/mlerner.github.io/edit/master/_posts/2023-04-16-perseus-a-fail-slow-detection-framework-for-cloud-storage-systems.md"
      >Submit a pull request!</a
    >
  </section>
</article>

<div id="portal-root">
  <div id="subscribe-container">
    <div id="gh-portal-triggerbtn-wrapper" class="gh-portal-triggerbtn-wrapper">
      <div class="gh-portal-triggerbtn-container with-label">
        <svg
          width="24"
          height="18"
          viewBox="0 0 24 18"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
          style="width: 24px; height: 24px; color: rgb(255, 255, 255)"
        >
          <path
            d="M21.75 1.5H2.25c-.828 0-1.5.672-1.5 1.5v12c0 .828.672 1.5 1.5 1.5h19.5c.828 0 1.5-.672 1.5-1.5V3c0-.828-.672-1.5-1.5-1.5zM15.687 6.975L19.5 10.5M8.313 6.975L4.5 10.5"
            stroke="#fff"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          ></path>
          <path
            d="M22.88 2.014l-9.513 6.56C12.965 8.851 12.488 9 12 9s-.965-.149-1.367-.426L1.12 2.014"
            stroke="#fff"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          ></path></svg
        ><span class="gh-portal-triggerbtn-label"> Subscribe </span>
      </div>
    </div>
  </div>
</div>

<div id="popup-root" style="visibility: hidden">
  <div class="inner-popup-container">
    <div class="gh-portal-popup-background"></div>
    <div class="gh-portal-popup-wrapper signup">
      <div
        class="gh-portal-popup-container gh-portal-container-narrow signup"
        tabindex="-1"
      >
        <div class="gh-portal-content signup noplan">
          <div id="closeicon-email" class="gh-portal-closeicon-container">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              class="gh-portal-closeicon"
              alt="Close"
            >
              <defs>
                <style>
                  .a {
                    fill: none;
                    stroke: currentColor;
                    stroke-linecap: round;
                    stroke-linejoin: round;
                    stroke-width: 1.2px;
                  }
                </style>
              </defs>
              <path
                class="a"
                d="M.75 23.249l22.5-22.5M23.25 23.249L.75.749"
              ></path>
            </svg>
          </div>
          <header>
            <h2 class="gh-portal-main-title">Get essays a bit faster</h2>
          </header>
          <section>
            <div class="gh-portal-section">
              <form
                action="https://gmail.us20.list-manage.com/subscribe/post?u=d1654f70a6addb0e9ce8afd83&amp;id=bab65ed2b1"
                method="post"
                id="mc-embedded-subscribe-form"
                name="mc-embedded-subscribe-form"
                class="validate"
                target="_blank"
                novalidate=""
                _lpchecked="1"
              >
                <label for="mce-EMAIL"> </label>
                <p id="mce-email-describe" class="mt0">
                  I write about computer science research from the fields of
                  distributed systems and operating systems around once a week.
                </p>
                <p></p>
                <div id="mc_embed_signup_scroll">
                  <div>
                    <input
                      type="email"
                      value=""
                      name="EMAIL"
                      class="email"
                      id="tlemail"
                      placeholder="email address"
                      required=""
                    />

                    <div
                      style="position: absolute; left: -5000px"
                      aria-hidden="true"
                    >
                      <input
                        type="text"
                        name="b_d1654f70a6addb0e9ce8afd83_bab65ed2b1"
                        tabindex="-1"
                        value=""
                      />
                    </div>
                    <input
                      type="submit"
                      value="Subscribe"
                      name="subscribe"
                      id="mc-embedded-subscribe"
                      class="button"
                    />
                  </div>
                </div>
              </form>
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>
</div>

<script id="mcjs">
  var subscribeButton = document.getElementById("gh-portal-triggerbtn-wrapper");
  var closeButton = document.getElementById("closeicon-email");
  var popupRoot = document.getElementById("popup-root");

  subscribeButton.addEventListener("click", function () {
    window.open('https://newsletter.micahlerner.com', '_blank');
    <!-- popupRoot.classList.toggle("m-fadeIn"); -->
    <!-- popupRoot.style.visibility = "visible"; -->
  });

  closeButton.addEventListener("click", function () {
    <!-- popupRoot.classList.toggle("m-fadeOut"); -->
    <!-- popupRoot.classList.toggle("m-fadeIn"); -->
    <!-- popupRoot.style.visibility = "hidden"; -->
  });
</script>

  </body>
</html>
