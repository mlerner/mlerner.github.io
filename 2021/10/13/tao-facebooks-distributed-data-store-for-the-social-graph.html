<!DOCTYPE html>
<html>
  <head>
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-LKBDWTJ60B"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-LKBDWTJ60B");
    </script>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>TAO: Facebook’s Distributed Data Store for the Social Graph</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />

    <meta http-equiv="pragma" content="no-cache" />
    <meta name="robots" content="all" />
    <meta name="MSSmartTagsPreventParsing" content="true" />
    <meta http-equiv="imagetoolbar" content="false" />

    <link href="/css/tufte.css" rel="stylesheet" />
    <link
      rel="alternate"
      type="application/atom+xml"
      title="Atom Feed for www.micahlerner.com"
      href="/atom.xml"
    />
    <link
      rel="alternate"
      type="application/atom+xml"
      title="RSS Feed for www.micahlerner.com"
      href="/feed.xml"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/assets/images/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/assets/images/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/assets/images/favicon-16x16.png"
    />
    <link rel="manifest" href="/assets/imagessite.webmanifest" />
  </head>

  <body>
    <article>
  <section>
    <header>
      <a href="/">
        <h3>micahlerner.com</h3>
      </a>
    </header>
  </section>
  <h1>TAO: Facebook’s Distributed Data Store for the Social Graph</h1>
  
  <h4>Published October 13, 2021</h4>
  <h5>
    Found something wrong?
    <a
      href="https://github.com/mlerner/mlerner.github.io/edit/master/_posts/2021-10-13-tao-facebooks-distributed-data-store-for-the-social-graph.md"
      >Submit a pull request!</a
    >
  </h5>
  <section id="post-content">
       <p class='discussion'>Discussion on <a href='https://news.ycombinator.com/item?id=29045443'> Hacker News</a></p>   <p><em>The papers over the next few weeks will be from (or related to) research from <a href="https://vldb.org/2021/?info-research-papers">VLDB 2021</a> - on the horizon is one of my favorite systems conferences <a href="https://sosp2021.mpi-sws.org/">SOSP</a>. As always, feel free to reach out on <a href="https://twitter.com/micahlerner">Twitter</a> with feedback or suggestions about papers to read! These paper reviews can <a href="https://newsletter.micahlerner.com/">be delivered weekly to your inbox</a>, or you can subscribe to the <a href="https://www.micahlerner.com/feed.xml">Atom feed</a>.</em></p>

<p><a href="https://www.usenix.org/system/files/conference/atc13/atc13-bronson.pdf">TAO: Facebook’s Distributed Data Store for the Social Graph</a></p>

<p>This is the first in a two part series on TAO<label for="tao" class="margin-toggle sidenote-number"></label><input type="checkbox" id="tao" class="margin-toggle" /><span class="sidenote">TAO stands for “The Associations and Objects” - associations are the edges in graph, and objects are the nodes. </span>, Facebook’s read-optimized, eventually-consistent graph database. Unlike other graph databases, TAO focuses exclusively on serving and caching a constrained set of application requests at scale (in contrast to systems focused on data analysis). Furthermore, the system builds on expertise scaling MySQL and memcache as discussed in a <a href="https://www.micahlerner.com/2021/05/31/scaling-memcache-at-facebook.html">previous paper review</a>.</p>

<p>The first paper in the series focuses on the original TAO paper, describing the motivation for building the system, it’s architecture, and engineering lessons learned along the way. The second part focuses on TAO-related research published at this year’s VLDB - <a href="https://www.vldb.org/pvldb/vol14/p3014-cheng.pdf">RAMP-TAO: Layering Atomic Transactions on Facebook’s Online TAO Data Store</a>. This new paper describes the design and implementation of transactions on top of the existing large scale distributed system - a task made more difficult by the requirement that applications should gradually migrate to the new functionality and that the work to support transactions should have limited impact on the performance of existing applications.</p>

<h2 id="what-are-the-papers-contributions">What are the paper’s contributions?</h2>

<p>The original TAO paper makes three contributions - characterizing and motivating a graph database implementation suited for Facebook’s read-heavy traffic, providing a data model and developer API for the aforementioned database, and describing the architecture that allowed the database to scale.</p>

<h2 id="motivation">Motivation</h2>

<p>The paper begins with a section describing the motivation for TAO’s initial development. When Facebook was originally developed, MySQL was used as the datastore for the graph. As the site scaled, a memcache layer was added in front of the MySQL databases, to lighten the load.</p>

<p>While inserting memcache into the stack worked for some period of time, the paper cites three main problems with the implementation: <em>inefficient edge lists</em>, <em>distributed control logic</em>, and <em>expensive read-after-write consistency</em>.</p>

<h3 id="inefficient-edge-lists">Inefficient edge lists</h3>

<p>Application developers within Facebook used <em>edge-lists</em> to represent aggregations of the information in the graph - for example, a list of the friendships a user has (each friendship is an edge in the graph, and the users are the nodes). Unfortunately, maintaining these lists in memcache was inefficient - memcache is a simple key value store without support for lists, meaning that common list-related functionality<label for="redis" class="margin-toggle sidenote-number"></label><input type="checkbox" id="redis" class="margin-toggle" /><span class="sidenote">Like that supported in <a href="https://redis.io/topics/data-types#lists">Redis</a>. </span>  is inefficient. If a list needs to be updated (say for example, a friendship is deleted), the logic to update the list would be complicated - in particular, the part of the logic related to coordinating the update of the list across several copies of the same data in multiple data centers.</p>

<h3 id="distributed-control-logic">Distributed Control Logic</h3>

<p>Control logic (in the context of Facebook’s graph store architecture) means the ability to manipulate how the system is accessed. Before TAO was implemented, the graph data store had <em>distributed control logic</em> - clients communciated directly with the memcache nodes, and there is not a single point of control to gate client access to the system. This property makes it difficult to guard against misbehaving clients and <a href="https://instagram-engineering.com/thundering-herds-promises-82191c8af57d">thundering herds</a>.</p>

<h3 id="expensive-read-after-write-consistency">Expensive read-after-write consistency</h3>

<p><em>Read-after-write consistency</em> means that if a client writes data, then performs a read of the data, the client should see the result of the write that it performed. If a system doesn’t have this property, users might be confused - “why did the like button they just pressed not register when they reloaded the page?”.</p>

<p>Ensuring read-after-write consistency was expensive and difficult for Facebook’s memcache-based system, which used MySQL databases with master/slave replication to propagate database writes between datacenters. While Facebook developed internal technology<label for="memcache" class="margin-toggle sidenote-number"></label><input type="checkbox" id="memcache" class="margin-toggle" /><span class="sidenote">As described in my previous paper review, <a href="https://www.micahlerner.com/2021/05/31/scaling-memcache-at-facebook.html">Scaling Memcache at Facebook</a>. </span> to stream changes between databases, existing systems that used the MySQL and memcache combo relied on complicated cache-invalidation logic<label for="cacheinvalid" class="margin-toggle sidenote-number"></label><input type="checkbox" id="cacheinvalid" class="margin-toggle" /><span class="sidenote">For example, followers would forward reads for cache keys invalidated by a write to the leader database, increasing load and incurring potentially slow inter-regional communication. </span> that incurred networking overhead. The goal of this new system is to avoid this overhead (with an approach described later in the paper).</p>

<h2 id="data-model-and-api">Data model and API</h2>

<p>TAO is an eventually consistent<label for="werner" class="margin-toggle sidenote-number"></label><input type="checkbox" id="werner" class="margin-toggle" /><span class="sidenote">For a description of eventual consistency (and related topics!), I highly recommend <a href="https://www.allthingsdistributed.com/2008/12/eventually_consistent.html">this post</a> from Werner Vogels. </span> read-optimized data store for the Facebook graph.</p>

<p>It stores two entities - <em>objects</em> and <em>associations</em> (the relationships between objects). Now we get to learn why the graph datastore is called TAO - the name is an abbreviation that stands for “The Associations and Objects”.</p>

<p>As an example of how <em>objects</em> and <em>associations</em> are used to model data, consider two common social network functions:</p>

<ul>
  <li><em>Friendships between users</em>: users in the database are stored as <em>objects</em>, and the relationship between users are <em>associations</em>.</li>
  <li><em>Check-ins</em>: the user and the location they check in to are <em>objects</em>. An <em>association</em> exists between them to represent that the given user has checked into a given location.</li>
</ul>

<p>Objects and associations have different database representations:</p>

<ul>
  <li>Each <em>object</em> in the database has an id and type.</li>
  <li>Each <em>association</em> contains the ids of the objects connected by the given edge, as well as the type of the association (check-in, friendship, etc). Additionally, each association has a timestamp that is used for querying (described later in the paper review).</li>
</ul>

<p>Key-value metadata can be associated with both objects and associations, although the possible keys, and value type are constrained by the type of the object or association.</p>

<figure><img class="maincolumn-img" src="/assets/tao-pt1/objects.png" /><figcaption class="maincolumn-figure"></figcaption></figure>

<p>To provide access to this data, TAO provides three main APIs: the <em>Object API</em>, the <em>Association API</em>, and the <em>Association Querying API</em>.</p>

<p>Two of the three (the <em>Object API</em> and <em>Association API</em>) provide create, read, update, and delete operations for individual objects.</p>

<p>In contrast, the <em>Association Querying API</em> provides an interface for performing common queries on the graph. The query methods allow application developers to fetch associations for a given object and type (potentially constraining by time range or the set of objects that the the association points), calculating the count of associations for an object, and providing pagination-like functionality. The paper provides example query patterns like fetching the “50 most recent comments on Alice’s checkin”  or “how many checkins at the GG Bridge?”. Queries in this API return multiple associations, and call this type of result an <em>association list</em>.</p>

<h2 id="architecture">Architecture</h2>

<p>The architecture of TAO contains two layers, the <em>storage layer</em> and the <em>caching layer</em>.</p>

<h3 id="storage-layer">Storage Layer</h3>

<p>The <em>storage layer</em> (as the name suggests) persists graph data in MySQL<label for="mysql" class="margin-toggle sidenote-number"></label><input type="checkbox" id="mysql" class="margin-toggle" /><span class="sidenote">Facebook has invested a significant amount of resources in their MySQL deployments, as evidenced by their <a href="https://engineering.fb.com/2016/08/31/core-data/myrocks-a-space-and-write-optimized-mysql-database/">MyRocks</a> storage engine and <a href="https://engineering.fb.com/2021/07/22/data-infrastructure/mysql/">other posts</a> on their tech blog. </span>. There are two key technical points to the storage layer: <em>shards</em> and the <em>tables</em> used to store the graph data itself.</p>

<p>The graph data is divided into <em>shards</em> (represented as a MySQL database), and shards are mapped to one of many database servers. Objects and associations for each shard are stored in separate tables.</p>

<h3 id="cache-layer">Cache Layer</h3>

<p>The cache layer is optimized for read requests and stores query results in memory. There are three key ideas in the cache layer: <em>cache servers</em>, <em>cache tiers</em>, and <em>leader/follower tiers</em>.</p>

<p>Clients communicate read and write requests to <em>cache servers</em>. Each <em>cache server</em> services requests for a set of shards in the <em>storage layer</em>, and caches objects, associatons, and the size of association lists (via the query patterns mentioned in the API section above).</p>

<p>A <em>cache tier</em> is a collection of <em>cache servers</em> that can respond to requests for all shards - the number of cache servers in each tier is configurable, as is the mapping from request to cache server.</p>

<p><em>Cache tiers</em> can be set up as <em>leaders</em> or <em>followers</em>. Whether a cache tier is a <em>leader</em> or a <em>follower</em> impacts its behavior:</p>

<ul>
  <li><em>Follower tiers</em> can serve read requests without communicating with the leader (although they forward read misses and write requests to the corresponding cache servers in the leader tier).</li>
  <li><em>Leader tiers</em> communicate with the storage layer (by reading and writing to/from the database), as well as with <em>follower</em> cache tiers. In the background, the <em>leader tier</em> sends cache update messages to <em>follower tiers</em> (resulting in the eventual consistency mentioned earlier on in this paper review).</li>
</ul>

<h2 id="scaling">Scaling</h2>

<p>To operate at large scale, TAO needed to extend beyond a single region. The system accomplishes this goal by using a master/slave configuration for each shard of the database.</p>

<figure><img class="maincolumn-img" src="/assets/tao-pt1/ms.png" /><figcaption class="maincolumn-figure"></figcaption></figure>

<p>In the master/slave configuration, each shard has a single <em>leader</em> cache tier and many <em>follower</em> cache tiers. The data in the storage layer for each shard is replicated from the master region to slave regions asynchronously.</p>

<p>A primary difference between the single region configuration described above and the multi-region configuration is the behavior of the <em>leader tier</em> when it receives writes. In a single-region configuration, the leader tier always forwards writes to the <em>storage layer</em>. In contrast, the leader tier in a multi-region TAO configuration writes to the <em>storage layer</em> only if the <em>leader tier</em> is in the <em>master region</em>. If the <em>leader tier</em> is not in the <em>master region</em> (meaning it is in a slave region!), then the <em>leader tier</em> needs to forward the write to the <em>master region</em>. Once the <em>master region</em> acknowledges the write, the slave region updates its local cache with the result of the write.</p>

<h2 id="conclusion">Conclusion</h2>

<p>TAO is a graph database operating at immense scale. The system was built on the emerging needs of Facebook, and had limited support for transactions<label for="txns" class="margin-toggle sidenote-number"></label><input type="checkbox" id="txns" class="margin-toggle" /><span class="sidenote">The paper mentions limited transaction-like behavior but does not provide significant details </span>. The next paper in the series discusses how transactions were added to the system, while maintaining performance for existing applications and providing an opt-in upgrade path for new applications.</p>

<p>As always, feel free to reach out on <a href="https://twitter.com/micahlerner">Twitter</a> with any feedback or paper suggestions. Until next time</p>


    <footer>
      <form
        action="https://gmail.us20.list-manage.com/subscribe/post?u=d1654f70a6addb0e9ce8afd83&amp;id=bab65ed2b1"
        method="post"
        id="mc-embedded-subscribe-form"
        name="mc-embedded-subscribe-form"
        class="validate"
        target="_blank"
        novalidate
      >
        <div id="mc_embed_signup_scroll">
          <h4>
            Follow me on
            <a href="https://twitter.com/micahlerner">Twitter</a> or subscribe
            below to get future paper reviews. Published weekly.
          </h4>
          <div>
            <input
              type="email"
              value=""
              name="EMAIL"
              class="email"
              id="tlemail"
              placeholder="email address"
              required
            />
            <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
            <div style="position: absolute; left: -5000px" aria-hidden="true">
              <input
                type="text"
                name="b_d1654f70a6addb0e9ce8afd83_bab65ed2b1"
                tabindex="-1"
                value=""
              />
            </div>
            <input
              type="submit"
              value="Subscribe"
              name="subscribe"
              id="mc-embedded-subscribe"
              class="button"
            />
          </div>
        </div>
      </form>
    </footer>
  </section>
  <section>
    Found something wrong?
    <a
      href="https://github.com/mlerner/mlerner.github.io/edit/master/_posts/2021-10-13-tao-facebooks-distributed-data-store-for-the-social-graph.md"
      >Submit a pull request!</a
    >
  </section>
</article>

<div id="portal-root">
  <div id="subscribe-container">
    <div id="gh-portal-triggerbtn-wrapper" class="gh-portal-triggerbtn-wrapper">
      <div class="gh-portal-triggerbtn-container with-label">
        <svg
          width="24"
          height="18"
          viewBox="0 0 24 18"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
          style="width: 24px; height: 24px; color: rgb(255, 255, 255)"
        >
          <path
            d="M21.75 1.5H2.25c-.828 0-1.5.672-1.5 1.5v12c0 .828.672 1.5 1.5 1.5h19.5c.828 0 1.5-.672 1.5-1.5V3c0-.828-.672-1.5-1.5-1.5zM15.687 6.975L19.5 10.5M8.313 6.975L4.5 10.5"
            stroke="#fff"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          ></path>
          <path
            d="M22.88 2.014l-9.513 6.56C12.965 8.851 12.488 9 12 9s-.965-.149-1.367-.426L1.12 2.014"
            stroke="#fff"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          ></path></svg
        ><span class="gh-portal-triggerbtn-label"> Subscribe </span>
      </div>
    </div>
  </div>
</div>

<div id="popup-root" style="visibility: hidden">
  <div class="inner-popup-container">
    <div class="gh-portal-popup-background"></div>
    <div class="gh-portal-popup-wrapper signup">
      <div
        class="gh-portal-popup-container gh-portal-container-narrow signup"
        tabindex="-1"
      >
        <div class="gh-portal-content signup noplan">
          <div id="closeicon-email" class="gh-portal-closeicon-container">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              class="gh-portal-closeicon"
              alt="Close"
            >
              <defs>
                <style>
                  .a {
                    fill: none;
                    stroke: currentColor;
                    stroke-linecap: round;
                    stroke-linejoin: round;
                    stroke-width: 1.2px;
                  }
                </style>
              </defs>
              <path
                class="a"
                d="M.75 23.249l22.5-22.5M23.25 23.249L.75.749"
              ></path>
            </svg>
          </div>
          <header>
            <h2 class="gh-portal-main-title">Get essays a bit faster</h2>
          </header>
          <section>
            <div class="gh-portal-section">
              <form
                action="https://gmail.us20.list-manage.com/subscribe/post?u=d1654f70a6addb0e9ce8afd83&amp;id=bab65ed2b1"
                method="post"
                id="mc-embedded-subscribe-form"
                name="mc-embedded-subscribe-form"
                class="validate"
                target="_blank"
                novalidate=""
                _lpchecked="1"
              >
                <label for="mce-EMAIL"> </label>
                <p id="mce-email-describe" class="mt0">
                  I write about computer science research from the fields of
                  distributed systems and operating systems around once a week.
                </p>
                <p></p>
                <div id="mc_embed_signup_scroll">
                  <div>
                    <input
                      type="email"
                      value=""
                      name="EMAIL"
                      class="email"
                      id="tlemail"
                      placeholder="email address"
                      required=""
                    />

                    <div
                      style="position: absolute; left: -5000px"
                      aria-hidden="true"
                    >
                      <input
                        type="text"
                        name="b_d1654f70a6addb0e9ce8afd83_bab65ed2b1"
                        tabindex="-1"
                        value=""
                      />
                    </div>
                    <input
                      type="submit"
                      value="Subscribe"
                      name="subscribe"
                      id="mc-embedded-subscribe"
                      class="button"
                    />
                  </div>
                </div>
              </form>
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>
</div>

<script id="mcjs">
  var subscribeButton = document.getElementById("gh-portal-triggerbtn-wrapper");
  var closeButton = document.getElementById("closeicon-email");
  var popupRoot = document.getElementById("popup-root");

  subscribeButton.addEventListener("click", function () {
    window.open('https://newsletter.micahlerner.com', '_blank');
    <!-- popupRoot.classList.toggle("m-fadeIn"); -->
    <!-- popupRoot.style.visibility = "visible"; -->
  });

  closeButton.addEventListener("click", function () {
    <!-- popupRoot.classList.toggle("m-fadeOut"); -->
    <!-- popupRoot.classList.toggle("m-fadeIn"); -->
    <!-- popupRoot.style.visibility = "hidden"; -->
  });
</script>

  </body>
</html>
